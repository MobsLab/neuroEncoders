#!/usr/bin/env bash
''':'
# ------------------------------
# Bash section (Linux/macOS)
# ------------------------------

set -euo pipefail

echo "[INFO] Running setup for Linux/macOS..."

# 1. Install system dependencies
if command -v apt-get &> /dev/null; then
    sudo apt-get update
    sudo apt-get install -y python3-dev python3-pip python3-venv python3-tk jq xmlstarlet curl
elif command -v brew &> /dev/null; then
    brew install python jq xmlstarlet curl
else
    echo "[WARN] Unknown package manager. Please install Python, jq, xmlstarlet, curl manually."
fi

# 2. Install uv if missing
if ! command -v uv &> /dev/null; then
    echo "[INFO] Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
fi

# 3. Sync dependencies
uv sync

# 4. Activate venv
source .venv/bin/activate

# 5. Install in editable mode
uv pip install -e .

echo "[SUCCESS] Linux/macOS setup complete."
exit 0
'''

# ------------------------------
# PowerShell section (Windows)
# ------------------------------
# This part runs if the above Bash exits immediately in PowerShell.

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

Write-Host "[INFO] Running setup for Windows..." -ForegroundColor Cyan

# 1. Check Python
if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
    Write-Host "[ERROR] Python is not installed. Install from https://www.python.org/downloads/" -ForegroundColor Red
    exit 1
}

# 2. Install uv if missing
if (-not (Get-Command uv -ErrorAction SilentlyContinue)) {
    Write-Host "[INFO] Installing uv..." -ForegroundColor Yellow
    irm https://astral.sh/uv/install.ps1 | iex
}

# 3. Sync dependencies
uv sync

# 4. Activate venv
$venvActivate = ".\.venv\Scripts\Activate.ps1"
if (-not (Test-Path $venvActivate)) {
    Write-Host "[ERROR] venv activation script not found." -ForegroundColor Red
    exit 1
}
& $venvActivate

# 5. Install in editable mode
uv pip install -e .

Write-Host "[SUCCESS] Windows setup complete." -ForegroundColor Green
